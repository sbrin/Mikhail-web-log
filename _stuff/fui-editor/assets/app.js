const iconsSrc = {
    "125_10px": "125_10px.png",
    "ActiveConnection_50x64": "ActiveConnection_50x64.png",
    "Alert_9x8": "Alert_9x8.png",
    "ArrowC_1_36x36": "ArrowC_1_36x36.png",
    "ArrowDownEmpty_14x15": "ArrowDownEmpty_14x15.png",
    "ArrowDownFilled_14x15": "ArrowDownFilled_14x15.png",
    "ArrowUpEmpty_14x15": "ArrowUpEmpty_14x15.png",
    "ArrowUpFilled_14x15": "ArrowUpFilled_14x15.png",
    "Attention_5x8": "Attention_5x8.png",
    "Auth_62x31": "Auth_62x31.png",
    "back_10px": "back_10px.png",
    "Background_128x11": "Background_128x11.png",
    "badusb_10px": "badusb_10px.png",
    "Battery_16x16": "Battery_16x16.png",
    "Battery_26x8": "Battery_26x8.png",
    "BatteryBody_52x28": "BatteryBody_52x28.png",
    "Ble_connected_15x15": "Ble_connected_15x15.png",
    "Ble_disconnected_15x15": "Ble_disconnected_15x15.png",
    "BLE_Pairing_128x64": "BLE_Pairing_128x64.png",
    "Bluetooth_Connected_16x8": "Bluetooth_Connected_16x8.png",
    "Bluetooth_Idle_5x8": "Bluetooth_Idle_5x8.png",
    "Button_18x18": "Button_18x18.png",
    "ButtonCenter_7x7": "ButtonCenter_7x7.png",
    "ButtonDown_7x4": "ButtonDown_7x4.png",
    "ButtonLeft_4x7": "ButtonLeft_4x7.png",
    "ButtonLeftSmall_3x5": "ButtonLeftSmall_3x5.png",
    "ButtonRight_4x7": "ButtonRight_4x7.png",
    "ButtonRightSmall_3x5": "ButtonRightSmall_3x5.png",
    "ButtonUp_7x4": "ButtonUp_7x4.png",
    "Certification1_103x56": "Certification1_103x56.png",
    "Certification2_98x33": "Certification2_98x33.png",
    "Charging-lightning_9x10": "Charging-lightning_9x10.png",
    "Charging-lightning_mask_9x10": "Charging-lightning_mask_9x10.png",
    "Circles_47x47": "Circles_47x47.png",
    "Clock_18x18": "Clock_18x18.png",
    "Connect_me_62x31": "Connect_me_62x31.png",
    "Connected_62x31": "Connected_62x31.png",
    "CoolHi_25x27": "CoolHi_25x27.png",
    "CoolHi_hvr_25x27": "CoolHi_hvr_25x27.png",
    "CoolLo_25x27": "CoolLo_25x27.png",
    "CoolLo_hvr_25x27": "CoolLo_hvr_25x27.png",
    "Cry_dolph_55x52": "Cry_dolph_55x52.png",
    "Dehumidify_25x27": "Dehumidify_25x27.png",
    "Dehumidify_hvr_25x27": "Dehumidify_hvr_25x27.png",
    "Detailed_chip_17x13": "Detailed_chip_17x13.png",
    "DFU_128x50": "DFU_128x50.png",
    "dir_10px": "dir_10px.png",
    "DolphinCommon_56x48": "DolphinCommon_56x48.png",
    "DolphinMafia_115x62": "DolphinMafia_115x62.png",
    "DolphinNice_96x59": "DolphinNice_96x59.png",
    "DolphinReadingSuccess_59x63": "DolphinReadingSuccess_59x63.png",
    "DolphinWait_61x59": "DolphinWait_61x59.png",
    "DoorLeft_70x55": "DoorLeft_70x55.png",
    "DoorRight_70x55": "DoorRight_70x55.png",
    "Down_25x27": "Down_25x27.png",
    "Down_hvr_25x27": "Down_hvr_25x27.png",
    "Drive_112x35": "Drive_112x35.png",
    "Error_18x18": "Error_18x18.png",
    "Error_62x31": "Error_62x31.png",
    "EviSmile1_18x21": "EviSmile1_18x21.png",
    "EviSmile2_18x21": "EviSmile2_18x21.png",
    "EviWaiting1_18x21": "EviWaiting1_18x21.png",
    "EviWaiting2_18x21": "EviWaiting2_18x21.png",
    "FaceCharging_29x14": "FaceCharging_29x14.png",
    "FaceConfused_29x14": "FaceConfused_29x14.png",
    "FaceNopower_29x14": "FaceNopower_29x14.png",
    "FaceNormal_29x14": "FaceNormal_29x14.png",
    "GameMode_11x8": "GameMode_11x8.png",
    "Health_16x16": "Health_16x16.png",
    "HeatHi_25x27": "HeatHi_25x27.png",
    "HeatHi_hvr_25x27": "HeatHi_hvr_25x27.png",
    "HeatLo_25x27": "HeatLo_25x27.png",
    "HeatLo_hvr_25x27": "HeatLo_hvr_25x27.png",
    "Hidden_window_9x8": "Hidden_window_9x8.png",
    "ibutt_10px": "ibutt_10px.png",
    "iButtonDolphinVerySuccess_108x52": "iButtonDolphinVerySuccess_108x52.png",
    "iButtonKey_49x44": "iButtonKey_49x44.png",
    "InfraredArrowDown_4x8": "InfraredArrowDown_4x8.png",
    "InfraredArrowUp_4x8": "InfraredArrowUp_4x8.png",
    "InfraredLearnShort_128x31": "InfraredLearnShort_128x31.png",
    "ir_10px": "ir_10px.png",
    "KeyBackspace_16x9": "KeyBackspace_16x9.png",
    "KeyBackspaceSelected_16x9": "KeyBackspaceSelected_16x9.png",
    "Keychain_39x36": "Keychain_39x36.png",
    "KeySave_24x11": "KeySave_24x11.png",
    "KeySaveSelected_24x11": "KeySaveSelected_24x11.png",
    "Left_mouse_icon_9x9": "Left_mouse_icon_9x9.png",
    "loading_10px": "loading_10px.png",
    "Lock_7x8": "Lock_7x8.png",
    "Lock_8x8": "Lock_8x8.png",
    "Medium-chip-22x21": "Medium-chip-22x21.png",
    "MHz_25x11": "MHz_25x11.png",
    "Modern_reader_18x34": "Modern_reader_18x34.png",
    "Move_flipper_26x39": "Move_flipper_26x39.png",
    "music_10px": "music_10px.png",
    "Mute_25x27": "Mute_25x27.png",
    "Mute_hvr_25x27": "Mute_hvr_25x27.png",
    "Nfc_10px": "Nfc_10px.png",
    "NFC_manual_60x50": "NFC_manual_60x50.png",
    "Off_25x27": "Off_25x27.png",
    "Off_hvr_25x27": "Off_hvr_25x27.png",
    "Ok_btn_9x9": "Ok_btn_9x9.png",
    "Ok_btn_pressed_13x13": "Ok_btn_pressed_13x13.png",
    "passport_bad1_46x49": "passport_bad1_46x49.png",
    "passport_bad2_46x49": "passport_bad2_46x49.png",
    "passport_bad3_46x49": "passport_bad3_46x49.png",
    "passport_bottom_128x18": "passport_bottom_128x18.png",
    "passport_happy1_46x49": "passport_happy1_46x49.png",
    "passport_happy2_46x49": "passport_happy2_46x49.png",
    "passport_happy3_46x49": "passport_happy3_46x49.png",
    "passport_left_6x46": "passport_left_6x46.png",
    "passport_okay1_46x49": "passport_okay1_46x49.png",
    "passport_okay2_46x49": "passport_okay2_46x49.png",
    "passport_okay3_46x49": "passport_okay3_46x49.png",
    "Percent_10x14": "Percent_10x14.png",
    "Pin_arrow_down_7x9": "Pin_arrow_down_7x9.png",
    "Pin_arrow_left_9x7": "Pin_arrow_left_9x7.png",
    "Pin_arrow_right_9x7": "Pin_arrow_right_9x7.png",
    "Pin_arrow_up_7x9": "Pin_arrow_up_7x9.png",
    "Pin_attention_dpad_29x29": "Pin_attention_dpad_29x29.png",
    "Pin_back_arrow_10x8": "Pin_back_arrow_10x8.png",
    "Pin_back_full_40x8": "Pin_back_full_40x8.png",
    "Pin_pointer_5x3": "Pin_pointer_5x3.png",
    "Pin_star_7x7": "Pin_star_7x7.png",
    "Power_25x27": "Power_25x27.png",
    "Power_hvr_25x27": "Power_hvr_25x27.png",
    "Pressed_Button_13x13": "Pressed_Button_13x13.png",
    "Quest_7x8": "Quest_7x8.png",
    "Reader_detect_43x40": "Reader_detect_43x40.png",
    "Release_arrow_18x15": "Release_arrow_18x15.png",
    "Restoring_38x32": "Restoring_38x32.png",
    "RFIDBigChip_37x36": "RFIDBigChip_37x36.png",
    "RFIDDolphinReceive_97x61": "RFIDDolphinReceive_97x61.png",
    "RFIDDolphinSend_97x61": "RFIDDolphinSend_97x61.png",
    "RFIDDolphinSuccess_108x57": "RFIDDolphinSuccess_108x57.png",
    "Right_mouse_icon_9x9": "Right_mouse_icon_9x9.png",
    "Scanning_123x52": "Scanning_123x52.png",
    "SDcardFail_11x8": "SDcardFail_11x8.png",
    "SDcardMounted_11x8": "SDcardMounted_11x8.png",
    "SDQuestion_35x43": "SDQuestion_35x43.png",
    "SmallArrowDown_3x5": "SmallArrowDown_3x5.png",
    "SmallArrowDown_4x7": "SmallArrowDown_4x7.png",
    "SmallArrowUp_3x5": "SmallArrowUp_3x5.png",
    "SmallArrowUp_4x7": "SmallArrowUp_4x7.png",
    "Smile_18x18": "Smile_18x18.png",
    "Space_65x18": "Space_65x18.png",
    "sub1_10px": "sub1_10px.png",
    "Tap_reader_36x38": "Tap_reader_36x38.png",
    "Temperature_16x16": "Temperature_16x16.png",
    "u2f_10px": "u2f_10px.png",
    "unknown_10px": "unknown_10px.png",
    "Unlock_7x8": "Unlock_7x8.png",
    "Unplug_bg_bottom_128x10": "Unplug_bg_bottom_128x10.png",
    "Unplug_bg_top_128x14": "Unplug_bg_top_128x14.png",
    "Up_25x27": "Up_25x27.png",
    "Up_hvr_25x27": "Up_hvr_25x27.png",
    "update_10px": "update_10px.png",
    "Updating_32x40": "Updating_32x40.png",
    "UsbTree_48x22": "UsbTree_48x22.png",
    "Vol_down_25x27": "Vol_down_25x27.png",
    "Vol_down_hvr_25x27": "Vol_down_hvr_25x27.png",
    "Vol_up_25x27": "Vol_up_25x27.png",
    "Vol_up_hvr_25x27": "Vol_up_hvr_25x27.png",
    "Voldwn_6x6": "Voldwn_6x6.png",
    "Voltage_16x16": "Voltage_16x16.png",
    "Volup_8x6": "Volup_8x6.png",
    "Warning_30x23": "Warning_30x23.png",
    "WarningDolphin_45x42": "WarningDolphin_45x42.png",
};
const canvasWidth = 128;
const canvasHeight = 64;
const canvasBoundX = canvasWidth * 4;
const canvasBoundY = canvasHeight * 4;

function bline(imgData, x0, y0, x1, y1) {
    const resultArr = [];
    const dx = Math.abs(x1 - x0),
        sx = x0 < x1 ? 1 : -1;
    const dy = Math.abs(y1 - y0),
        sy = y0 < y1 ? 1 : -1;
    let err = (dx > dy ? dx : -dy) / 2;
    while (true) {
        resultArr.push([x0, y0]);
        if (x0 === x1 && y0 === y1) break;
        var e2 = err;
        if (e2 > -dx) {
            err -= dy;
            x0 += sx;
        }
        if (e2 < dy) {
            err += dx;
            y0 += sy;
        }
    }
    for (let i = 0; i < resultArr.length; i++) {
        const [x, y] = resultArr[i];
        const n = (y * canvasWidth + x) * 4;

        imgData.data[n] = 0;
        imgData.data[n + 1] = 0;
        imgData.data[n + 2] = 0;
        imgData.data[n + 3] = 255;
    }
}

function maskBlack(imgData) {
    for (var i = 0; i < imgData.data.length; i += 4) {
        if (imgData.data[i] + imgData.data[i + 1] + imgData.data[i + 2] >= 10) {
            imgData.data[i + 3] = 0; // alpha
        }
    }
    return imgData;
}

Vue.createApp({
        template: "#fui-editor",
        data() {
            return {
                layerIndex: 1,
                fuiImages: {},
                codePreview: "",
                screenElements: [],
                screenCurrentElement: null,
                mouseClick_x: 0,
                mouseClick_y: 0,
                mouseClick_dx: 0,
                mouseClick_dy: 0,
                oX: 0,
                oY: 0,
                activeTool: "frame",
                mainTab: "icons",
                isDrawing: false,
                isMoving: false,
            };
        },
        computed: {
            screenRawElements() {
                return this.screenElements.filter((item) => ["line"].includes(item.type));
            },
            screenSimpleElements() {
                return this.screenElements.filter(
                    (item) => !["line"].includes(item.type)
                );
            }
        },
        methods: {
            setMainTab(tab) {
                this.mainTab = tab;
            },
            prepareImages(e) {
                console.log("prepareImages", e);
                this.fuiImages = e;
            },
            setActiveTool(tool) {
                this.activeTool = tool;
            },
            setCurrentItem(item) {
                this.screenCurrentElement = item;
            },
            removeElement(index) {
                this.screenCurrentElement = undefined;
                this.screenElements = this.screenElements.filter(
                    (item) => item.index !== index
                );
                this.generateCode(this.screenElements);
                this.redrawCanvas();
            },
            addImageToCanvas(name, x = 32, y = 16) {
                this.screenElements.push({
                    type: "icon",
                    x: x,
                    y: y,
                    width: this.fuiImages[name].width,
                    height: this.fuiImages[name].height,
                    name: name,
                    index: this.layerIndex
                });
                this.screenCurrentElement = this.screenElements.find(item => item.index === this.layerIndex);
                this.layerIndex += 1;
                this.generateCode(this.screenElements);
                this.redrawCanvas();
                this.activeTool = "select";
            },
            canvasOnDrop(e) {
                e.preventDefault();
                const name = e.dataTransfer.getData("name");
                const [offsetSrcImgX, offsetSrcImgY] = e.dataTransfer
                    .getData("offset")
                    .split(",");
                const offsetTargetX = Math.round(
                    this.scaleDown(e.offsetX) - offsetSrcImgX
                );
                const offsetTargetY = Math.round(
                    this.scaleDown(e.offsetY) - offsetSrcImgY
                );
                
                this.addImageToCanvas(name, offsetTargetX, offsetTargetY);
                
            },
            canvasMouseDown(e) {
                e.preventDefault();
                if (e.button !== 0) {
                    return;
                }
                const [x, y] = [e.offsetX, e.offsetY];
                this.mouseClick_x = x - (x % 4);
                this.mouseClick_y = y - (y % 4);
                this.screenCurrentElement = undefined;
                const current = this.getElementByOffset(this.screenElements, x, y);
                this.isDrawing = true;
                console.log(current);

                if (["frame", "box", "dot"].includes(this.activeTool)) {
                    this.screenCurrentElement = {
                        type: this.activeTool,
                        x: this.scaleDown(x),
                        y: this.scaleDown(y),
                        width: 1,
                        height: 1,
                        index: this.layerIndex
                    };
                    this.layerIndex += 1;
                    this.screenElements.push(this.screenCurrentElement);
                } else if (this.activeTool === "line") {
                    this.screenCurrentElement = {
                        type: this.activeTool,
                        x: this.scaleDown(x),
                        y: this.scaleDown(y),
                        x2: this.scaleDown(x),
                        y2: this.scaleDown(y),
                        width: 0,
                        height: 0,
                        index: this.layerIndex
                    };
                    this.layerIndex += 1;
                    this.screenElements.push(this.screenCurrentElement);
                } else if (this.activeTool === "str") {
                    this.screenCurrentElement = {
                        type: this.activeTool,
                        x: this.scaleDown(x),
                        y: this.scaleDown(y),
                        yy: this.scaleDown(y) - 8,
                        index: this.layerIndex,
                        text: "Text string",
                        width: 50,
                        height: 8,
                        font: "FontSecondary"
                    };
                    this.layerIndex += 1;
                    this.screenElements.push(this.screenCurrentElement);
                } else if (current) {
                    this.isMoving = true;
                    this.screenCurrentElement = current;
                    const currentX = this.scaleUp(this.screenCurrentElement.x);
                    const currentY = this.scaleUp(this.screenCurrentElement.y);
                    this.mouseClick_dx = this.mouseClick_x - currentX;
                    this.mouseClick_dy = this.mouseClick_y - currentY;
                }
            },
            canvasMouseMove(e) {
                e.preventDefault();
                if (!this.screenCurrentElement || !this.isDrawing) {
                    return;
                }
                let x =
                    this.mouseClick_x > canvasBoundX ? canvasBoundX : this.mouseClick_x;
                let y =
                    this.mouseClick_y > canvasBoundY ? canvasBoundY : this.mouseClick_y;
                if (["line", "frame", "box"].includes(this.activeTool)) {
                    if (
                        e.offsetX >= 0 &&
                        e.offsetY >= 0 &&
                        e.offsetX < canvasBoundX &&
                        e.offsetY < canvasBoundY
                    ) {
                        if (this.activeTool === "frame") {
                            x = x >= canvasBoundX - 4 ? canvasBoundX - 4 : x;
                            y = y >= canvasBoundY - 4 ? canvasBoundY - 4 : y;
                        }
                        this.screenCurrentElement.x = this.scaleDown(x);
                        this.screenCurrentElement.y = this.scaleDown(y);

                        if (["line"].includes(this.activeTool)) {
                            this.screenCurrentElement.x2 = this.scaleDown(e.offsetX);
                            this.screenCurrentElement.y2 = this.scaleDown(e.offsetY);
                        }
                        if (["frame", "box"].includes(this.activeTool)) {
                            const width = e.offsetX - this.mouseClick_x;
                            const height = e.offsetY - this.mouseClick_y;
                            this.screenCurrentElement.width = this.scaleSize(width);
                            this.screenCurrentElement.height = this.scaleSize(height);
                        }
                    }
                } else if (this.activeTool === "dot") {
                    this.screenCurrentElement.x = this.scaleDown(e.offsetX);
                    this.screenCurrentElement.y = this.scaleDown(e.offsetY);
                } else {
                    x = e.offsetX - this.mouseClick_dx;
                    y = e.offsetY - this.mouseClick_dy;
                    if (["str"].includes(this.screenCurrentElement.type)) {
                        this.screenCurrentElement.yy = this.scaleDown(y) - 8;
                    }
                    if (["line"].includes(this.screenCurrentElement.type)) {
                        const {x: x1, y: y1, x2, y2} = this.screenCurrentElement;
                        const width = Math.abs(x2 - x1);
                        const height = Math.abs(y2 - y1);
                        if (x2 > x1) {
                            this.screenCurrentElement.x2 = this.scaleDown(x) + width;
                        } else {
                            this.screenCurrentElement.x2 = this.scaleDown(x) - width;
                        }
                        if (y2 > y1) {
                            this.screenCurrentElement.y2 = this.scaleDown(y) + height;
                        } else {
                            this.screenCurrentElement.y2 = this.scaleDown(y) - height;
                        }
                    }
                    this.screenCurrentElement.x = this.scaleDown(x);
                    this.screenCurrentElement.y = this.scaleDown(y);
                }
                this.redrawCanvas();
            },
            canvasMouseLeave(e) {
                e.preventDefault();
                if (this.activeTool === "select") {
                    this.isMoving = false;
                    this.stopDrawing(e);
                }
            },
            canvasMouseUp(e) {
                if (this.isDrawing) {
                    e.preventDefault();
                    this.isMoving = false;
                    this.stopDrawing(e);
                    this.redrawCanvas();
                }
            },
            stopDrawing() {
                if (this.isDrawing && this.screenCurrentElement) {
                    this.isDrawing = false;
                    if (this.activeTool === "frame" || this.activeTool === "box") {
                        if (this.screenCurrentElement.width < 0) {
                            this.screenCurrentElement.width = Math.abs(
                                this.screenCurrentElement.width
                            );
                            this.screenCurrentElement.x -= this.screenCurrentElement.width;
                        }
                        if (this.screenCurrentElement.height < 0) {
                            this.screenCurrentElement.height = Math.abs(
                                this.screenCurrentElement.height
                            );
                            this.screenCurrentElement.y -= this.screenCurrentElement.height;
                        }
                        console.log("stopDrawing", this.screenCurrentElement);
                    }
                }
                this.generateCode(this.screenElements);
            },
            redrawCanvas() {
                console.log("redrawCanvas");
                this.ctx.save();
                this.ctx.clearRect(0, 0, canvasWidth, canvasHeight);
                for (let i = 0; i < this.screenElements.length; i++) {
                    const {
                        name,
                        x,
                        y,
                        x2,
                        y2,
                        width,
                        height,
                        type,
                        text,
                        font
                    } = this.screenElements[i];
                    if (type === "frame") {
                        console.log(x + 0.5, y + 0.5, width, height);
                        this.ctx.strokeRect(x + 0.5, y + 0.5, width, height);
                    } else if (type === "box") {
                        this.ctx.fillRect(x, y, width, height);
                    } else if (type === "dot") {
                        this.ctx.fillRect(x, y, 1, 1);
                    } else if (type === "icon") {
                        this.ctx.drawImage(this.fuiImages[name].element, x, y);
                    } else if (type === "line") {
                        const imgData = this.ctx.getImageData(
                            0,
                            0,
                            canvasWidth,
                            canvasHeight
                        );
                        bline(imgData, x, y, x2, y2);
                        this.ctx.putImageData(imgData, 0, 0);
                    } else if (type === "str") {
                        this.ctx.font = `16px ${font}`;
                        this.ctx.fillText(text, x, y);
                    }
                }
                const imgData = this.ctx.getImageData(0, 0, canvasWidth, canvasHeight);
                const newImgData = maskBlack(imgData);
                this.ctx.putImageData(newImgData, 0, 0);
                this.ctx.restore();
            },
            resetScreen() {
                this.screenElements = [];
                this.redrawCanvas();
                this.codePreview = "";
                this.screenCurrentElement = undefined;
            },
            getElementByOffset(uiArr, x, y) {
                for (let i = uiArr.length - 1; i >= 0; i--) {
                    const element = uiArr[i];
                    const scaledX1 = this.scaleUp(element.x);
                    const scaledY1 = this.scaleUp(element.yy ? element.yy : element.y);
                    const scaledX2 = this.scaleUp(element.x + element.width);
                    const scaledY2 = this.scaleUp(element.yy ? element.yy + element.height : element.y + element.height);
                    if (element.type === "line") {
                        const isVertical = element.y === element.y2;
                        const isHorisontal = element.y === element.y2;
                        const scaledX1 = this.scaleUp(element.x);
                        const scaledY1 = this.scaleUp(element.y);
                        const scaledX2 = this.scaleUp(element.x2);
                        const scaledY2 = this.scaleUp(element.y2);
                        if (scaledX2 > scaledX1) {
                            const isXInside = x >= scaledX1 - 4 && x <= scaledX2 + 4;
                            if (scaledY2 > scaledY1) {
                                if (isXInside && y >= scaledY1 - 4 && y <= scaledY2 + 4) {
                                    return element;
                                };
                            } else {
                                if (isXInside && y <= scaledY1 + 4 && y >= scaledY2 - 4) {
                                    return element;
                                }
                            }
                        } else {
                            const isXInside = x <= scaledX1 + 4 && x >= scaledX2 - 4;
                            if (scaledY2 > scaledY1) {
                                if (isXInside && y >= scaledY1 - 4 && y <= scaledY2 + 4) {
                                    return element;
                                }
                            } else {
                                if (isXInside && y <= scaledY1 + 4 && y >= scaledY2 - 4) {
                                    return element;
                                }
                            }
                        }
                    } else if (scaledX1 <= x && x < scaledX2 && scaledY1 <= y && y < scaledY2) {
                        console.log(element);
                        return element;
                    }
                }
            },
            scaleUp(i) {
                return 4 * i;
            },
            scaleDown(i) {
                return Math.round(i / 4);
            },
            scaleSize(i) {
                return i > 0 ? Math.round(i / 4) : Math.floor(i / 4);
            },
            getCode(element) {
                const func = `canvas_draw_${element.type}`;
                switch (element.type) {
                    case "icon":
                        return `${func}(canvas, ${element.x}, ${element.y}, &I_${element.name})`;
                    case "box":
                        return `${func}(canvas, ${element.x}, ${element.y}, ${element.width}, ${element.height})`;
                    case "dot":
                        return `${func}(canvas, ${element.x}, ${element.y})`;
                    case "frame":
                        return `${func}(canvas, ${element.x}, ${element.y}, ${element.width + 1
        }, ${element.height + 1})`;
                    case "line":
                        return `${func}(canvas, ${element.x}, ${element.y}, ${element.x2}, ${element.y2})`;
                    case "str":
                        return `canvas_set_font(canvas, FontSecondary);
${func}(canvas, ${element.x}, ${element.y}, "${element.text}")`;
                    default:
                }
            },
            generateCode(uiArr) {
                let lines = "";
                for (let i = 0; i < uiArr.length; i++) {
                    const element = uiArr[i];
                    lines = `${lines}${this.getCode(element)};

`;
                }
                this.codePreview = lines;
            },
            getLayerListItem(element) {
                if (element.type === "str") {
                    return `${element.text}`;
                }
                if (element.type === "icon") {
                    return `${element.name}`;
                }
                return `${element.type}`;
            },
            copyCode() {
                navigator.clipboard.writeText(this.codePreview);
            }
        },
        mounted() {
            this.ctx = this.$refs.screen.getContext("2d");
            this.ctx.strokeWidth = 1;
            this.ctx.textRendering = "optimizeSpeed";

            document.addEventListener("mouseup", this.canvasMouseUp);
        }
    })
    .component("fui-button", {
        template: "#fui-button",
        props: {
            title: String,
            active: Boolean
        }
    })
    .component("fui-icons", {
        template: "#fui-icons",
        data() {
            return {
                imagesSrc: [],
            };
        },
        methods: {
            iconClick(e) {
                console.log(e.target.dataset.name);
                this.$emit("iconClicked", e.target.dataset.name);
            },
            iconDragStart(e) {
                e.dataTransfer.setData("name", e.srcElement.dataset.name);
                e.dataTransfer.setData("offset", `${e.offsetX}, ${e.offsetY}`);
            },
            prepareImages() {
                const fuiImages = {};
                Object.entries(iconsSrc).forEach((item) => {
                    const [name, file] = item;
                    const matchedSizeArr = name.match(/_([0-9]+)x([0-9]+)/i) ? name.match(/_([0-9]+)x([0-9]+)/i) : [0, 10, 10];
                    const [, width, height] = matchedSizeArr.map((num) => parseInt(num, 10));
                    const image = new Image(width, height);
                    const src = `img/${file}`;
                    image.src = src;
                    image.crossOrigin = "Anonymous";
                    fuiImages[name] = {
                        src: src,
                        name: name,
                        element: image,
                        width: width,
                        height: height
                    };
                    this.imagesSrc.push({
                        src: src,
                        name: name,
                        element: image,
                        width: width,
                        height: height
                    });
                });
                this.imagesSrc.sort((a, b) => a.width * a.height - b.width * b.height);
                this.$emit("prepareImages", fuiImages);
            }
        },
        mounted() {
            this.prepareImages();
        }
    })
    .component("fui-tools", {
        template: "#fui-tools",
        props: {
            callback: Function,
            activeTool: String
        },
        data() {
            return {
                toolsList: ["frame", "box", "line", "dot"]
            };
        }
    })
    .component("fui-inspector", {
        template: "#fui-inspector",
        props: {
            elem: Object
        },
        data() {
            return {};
        },
        methods: {
            redrawCanvas() {
                this.$emit('redrawCanvas');
            },
            isHWVisible(elem) {
                return !['line','str','dot','icon'].includes(elem.type);
            }
        }
    })
    .component("fui-code", {
        template: "#fui-code",
        props: {
            content: String
        },
    })
    .component("fui-tabs", {
        template: "#fui-tabs",
        props: {
            activeTab: String
        },
        data() {
            return {
                tabs: ["icons", "code"],
            };
        },
        methods: {
            setActiveTab(tab) {
                this.$emit("setActiveTab", tab);
            }
        }
    })
    .component("fui-inspector-input", {
        template: "#fui-inspector-input",
        props: {
            element: Object,
            type: String,
            field: String,
        },
        methods: {
            onInput(e) {
                this.element[this.field] = this.type === "text" ? e.target.value : parseInt(e.target.value);
                this.$emit('redrawCanvas');
            }
        }
    })
    .mount("#fuigen_app");